import{s as de,u as ae,P as ge,a as ve,g as W,t as ne,p as oe,o as se,r as be}from"./index-LJ8e8yHT.js";import{f as K,K as ee,r as D,w as le,o as u,g as U,h as c,a as H,v as h,x as i,_ as he,i as y,y as ce,A as k,C as Y,F as M,s as pe,z as Z,I as a,B as j,ag as ie,ah as ye,ai as ke,aj as X,ak as xe,al as Ve,D as $e,L as ue,j as we}from"./vendor-DwjfiTos.js";import{B as me}from"./Bucket-W6Z8tqrK.js";import{_ as Ce,a as ze}from"./uplog-md.vue_vue_type_style_index_0_lang-P4m2D3oi.js";import{I as Ue}from"./Image-hYrnd1mX.js";import{d as Se}from"./dragBox-HwnoLvLV.js";const Ie={class:"plugin-readme"},Ae=K({__name:"plugin-readme",props:{plugin_name:{default:""},plugin_version:{default:""}},setup(E){const p=E,v=ee(()=>`${de}${p.plugin_name}/${p.plugin_version}/files`),s=D("");function C(){fetch(`${v.value}/README.md`).then(f=>f.text()).then(f=>{s.value=f})}return le(()=>p.plugin_name,()=>{C()},{immediate:!0,deep:!0}),(f,S)=>(u(),U("div",Ie,[c(Ce,{value:s.value},null,8,["value"])]))}}),De=a("p",{class:"bucket-tips",style:{color:"red"}},"* 添加成功后不可修改",-1),Be=["innerHTML"],Re=K({__name:"EditDialog",props:{modelValue:{type:Boolean,default:!1},detail:{default:()=>({})}},emits:["update:modelValue","submit"],setup(E,{emit:p}){const v=E,s=p,C=new me,f=ae(),S=new ge,z=ee({get(){return v.modelValue},set(d){s("update:modelValue",d)}}),l=H({name:"",config:{},visible:!0,user_plugin_id:""}),P=D(null),B=D([]),q=D([]),N=D("config"),A=D(),m=D(!1);(()=>{S.installed({status:!0,type:"uploader"}).then(d=>{B.value=d.items,l.user_plugin_id&&_(l.user_plugin_id)})})();const F=(d,e,o,n)=>d.default?n():n(`请输入${d.field}`),L=d=>d.required?{required:d.required,trigger:["blur","change"],validator:(e,o,n)=>{F(d,e,o,n)}}:"",R=()=>{z.value=!1},O=()=>{P.value.validate(d=>{if(d){let e={};q.value.forEach(n=>{e[n.field]=n.default});const o={name:l.name,user_plugin_id:l.user_plugin_id,config:e};l.id?G({id:l.id,...o}):J(o)}})},J=d=>{C.create(d).then(e=>{R(),s("submit"),f.$message({message:"新建成功",duration:1e3,type:"success"})})},G=d=>{C.update(d).then(async e=>{R(),s("submit"),f.$message({message:"更新成功",duration:1e3,type:"success"})})},_=d=>{if(A.value=B.value.find(e=>e.id===d),A.value){const{plugin:{name:e},version:o}=A.value,n=`${de}${e}/${o}/files/dist/index.js`;m.value=!0,he(()=>import(n+"?time="+Math.random()),__vite__mapDeps([])).then(b=>{q.value=b.default.config.map(g=>(l.config&&l.config[g.field]&&!g.hidden&&(g.default=l.config[g.field]),g)),m.value=!1}).catch(b=>{m.value=!1})}};return le(()=>l.user_plugin_id,d=>{B.value.length&&_(d)}),le(()=>v.detail,d=>{if(d){l.id=v.detail.id;for(let e in l)l[e]=v.detail[e]}},{immediate:!0}),(d,e)=>{const o=y("el-option"),n=y("el-select"),b=y("el-form-item"),g=y("el-input"),x=y("el-switch"),V=y("el-tab-pane"),w=y("el-tabs"),$=y("el-form"),T=y("el-button"),Q=y("com-dialog"),_e=ce("loading");return u(),h(Q,{modelValue:z.value,"onUpdate:modelValue":e[3]||(e[3]=t=>z.value=t),title:d.detail&&d.detail.id?"编辑存储桶":"新建存储桶",width:"700px","before-close":R},{action:i(()=>[c(T,{onClick:R},{default:i(()=>[k("取 消")]),_:1}),c(T,{type:"primary",onClick:O},{default:i(()=>[k("确 定")]),_:1})]),default:i(()=>[c($,{ref_key:"formRef",ref:P,model:l,"label-width":"auto","label-position":"left",class:"dict-form"},{default:i(()=>[c(b,{label:"存储桶插件",prop:"user_plugin_id",rules:[{required:!0,message:"请选择存储桶插件",trigger:["blur","change"]}]},{default:i(()=>[De,c(n,{modelValue:l.user_plugin_id,"onUpdate:modelValue":e[0]||(e[0]=t=>l.user_plugin_id=t),style:{width:"100%"},filterable:"",size:"large",disabled:!!l.id},{default:i(()=>[(u(!0),U(M,null,Y(B.value,(t,te)=>(u(),h(o,{key:te,label:t.plugin.title,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),c(b,{label:"存储桶名称",prop:"name",rules:[{required:!0,message:"请输入存储桶名称",trigger:["blur","change"]}]},{default:i(()=>[c(g,{modelValue:l.name,"onUpdate:modelValue":e[1]||(e[1]=t=>l.name=t),size:"large",placeholder:"请输入存储桶名称"},null,8,["modelValue"])]),_:1}),l.user_plugin_id?pe((u(),h(w,{key:0,modelValue:N.value,"onUpdate:modelValue":e[2]||(e[2]=t=>N.value=t),class:"bucket-tabs"},{default:i(()=>[c(V,{label:"存储桶配置",name:"config"},{default:i(()=>[(u(!0),U(M,null,Y(q.value,(t,te)=>(u(),U(M,{key:"form-item"+l.user_plugin_id+te},[t.hidden?Z("",!0):(u(),h(b,{key:0,label:t.label,prop:t.field,rules:[L(t)]},{default:i(()=>[t.type==="option"?(u(),h(n,{key:0,filterable:"",modelValue:t.default,"onUpdate:modelValue":I=>t.default=I,size:"large",style:{width:"100%"},placeholder:t.placeholder,disabled:t.disabled},{default:i(()=>[(u(!0),U(M,null,Y(t.options,(I,fe)=>(u(),h(o,{key:"item-"+fe,label:I.label,value:I.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","disabled"])):t.type==="password"?(u(),h(g,{key:1,modelValue:t.default,"onUpdate:modelValue":I=>t.default=I,size:"large",placeholder:t.placeholder,disabled:t.disabled,"show-password":""},null,8,["modelValue","onUpdate:modelValue","placeholder","disabled"])):t.type==="choice"?(u(),h(x,{key:2,modelValue:t.default,"onUpdate:modelValue":I=>t.default=I,size:"large","active-text":t.choices.active.label,"active-value":t.choices.active.value,"inactive-text":t.choices.inactive.label,"inactive-value":t.choices.inactive.value},null,8,["modelValue","onUpdate:modelValue","active-text","active-value","inactive-text","inactive-value"])):t.type==="string-textarea"?(u(),h(g,{key:3,modelValue:t.default,"onUpdate:modelValue":I=>t.default=I,size:"large",placeholder:t.placeholder,disabled:t.disabled,type:"textarea",rows:4},null,8,["modelValue","onUpdate:modelValue","placeholder","disabled"])):(u(),h(g,{key:4,modelValue:t.default,"onUpdate:modelValue":I=>t.default=I,size:"large",placeholder:t.placeholder,disabled:t.disabled},null,8,["modelValue","onUpdate:modelValue","placeholder","disabled"])),t.tips?(u(),U("p",{key:5,class:"bucket-tips",innerHTML:t.tips},null,8,Be)):Z("",!0)]),_:2},1032,["label","prop","rules"]))],64))),128))]),_:1}),c(V,{label:"插件介绍",name:"intro"},{default:i(()=>[N.value==="intro"?(u(),h(Ae,{key:0,plugin_name:A.value.plugin.name,plugin_version:A.value.version},null,8,["plugin_name","plugin_version"])):Z("",!0)]),_:1}),c(V,{label:"更新日志",name:"uplog"},{default:i(()=>[N.value==="uplog"?(u(),h(ze,{key:0,plugin_name:A.value.plugin.name,plugin_version:A.value.version},null,8,["plugin_name","plugin_version"])):Z("",!0)]),_:1})]),_:1},8,["modelValue"])),[[_e,m.value]]):Z("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}});function je(E,p){return new Promise((v,s)=>{const C=new FileReader;C.readAsDataURL(E),C.onload=function(){const f=new Image;f.onload=()=>{v(!0)},f.onerror=()=>{v(!1)},f.src=this.result.toString()}})}const Ee={style:{color:"red"}},Pe={class:"migrate-item"},Fe=a("div",{class:"migrate-item-title"},"Excel方式",-1),Ne=a("div",{class:"migrate-item-desc"},[a("p",null,[k("1. 上传excel文件，自动将excel中的图片上传到本存储桶中，"),a("a",{href:"/template.xlsx",download:"template.xlsx"},"下载模板"),k(";")]),a("p",null,"2. 导出excel文件，自动将本存储桶中的图片数据自动导出到excel中;"),a("p",null,[a("b",null,"注意: 导入时只会导入符合标准的文件，不符合标准的文件将被略过!!!")]),a("p",null,[a("b",null,"注意: 目前由于所有操作都是在客户端处理，会出现跨域异常错误，待处理!!!")])],-1),Ze={class:"migrate-item-main"},qe={class:"migrate-item"},Le=a("div",{class:"migrate-item-title"},"ZIP方式",-1),Te=a("div",{class:"migrate-item-desc"},[a("p",null,"1. 上传zip压缩包，自动将zip包中的所有图片上传到本存储桶中;"),a("p",null,"2. 导出zip文件，自动将本存储桶中的图片下载并保存到zip包中;"),a("p",null,[a("b",null,"注意: 导入时只会导入符合标准的文件，不符合标准的文件将被略过!!!")]),a("p",null,[a("b",null,"注意: 目前由于所有操作都是在客户端处理，会出现跨域异常错误，待处理!!!")])],-1),Me={class:"migrate-item-main"},Oe=K({__name:"MigrateDialog",props:{modelValue:{type:Boolean,default:!1},detail:{default:()=>({})}},emits:["update:modelValue","submit"],setup(E,{emit:p}){const v=E,s=p,C=new Ue,f=ae(),S=ve(),z=ee({get(){return v.modelValue},set(e){s("update:modelValue",e)}}),l=H({export_excel:!1,export_zip:!1,import_excel:!1,import_zip:!1}),P=D([]),B=ee(()=>{const e=S.systemConfig;return e.system.accept_str="."+e.system.accept.join(",."),e});function q(){d(),s("submit")}function N(){C.find({bucket_id:v.detail.id}).then(e=>{P.value=e.items.map(o=>({...o,img_preview_url:o.baseurl+o.url}))})}N();function A(){l.export_zip=!0;var e=new ie,o=P.value.length,n=v.detail.name+".zip";P.value.forEach((b,g)=>{ye.getBinaryContent(b.baseurl+b.url,(x,V)=>{if(x)throw x;e.file(b.name,V,{binary:!0}),o--,o===0&&e.generateAsync({type:"blob"}).then(w=>{ke.saveAs(w,n),l.export_zip=!1})})})}function m(){l.export_excel=!0;const e=X.json_to_sheet(P.value.map(n=>({img_name:n.name,origin_name:n.origin_name,img_preview_url:n.baseurl+n.url}))),o=X.book_new();X.book_append_sheet(o,e,"Sheet1"),xe(o,v.detail.name+".xlsx"),l.export_excel=!1}const r=D();function F(){r.value.click()}function L(e){const o=e.target.files[0];if(!o){l.import_zip=!1;return}l.import_zip=!0;var n=new FileReader;n.onload=function(){var b=new ie;b.loadAsync(n.result).then(g=>{var x=Object.keys(g.files).filter(w=>{const $=B.value.system;return w&&$.accept.includes(W(w))});const V=x.map(w=>g.file(w).async("blob"));_(V,x,"import_zip")})},n.readAsArrayBuffer(o)}const R=D();function O(){R.value.click()}function J(e){const o=e.target.files[0];if(!o){l.import_excel=!1;return}l.import_excel=!0;var n=new FileReader;n.onload=b=>{var g=new Uint8Array(b.target.result),x=Ve(g,{type:"array"});const V=X.sheet_to_json(x.Sheets[x.SheetNames[0]]).filter($=>{const T=B.value.system;return $.img_name&&T.accept.includes(W($.img_name))}),w=V.map($=>fetch($.img_preview_url).then(T=>T.blob()));_(w,V.map($=>$.img_name),"import_excel")},n.readAsArrayBuffer(o)}function G(e,o){console.log("上传图片",e,o)}function _(e,o,n){console.log(e,o),Promise.all(e).then(b=>{const g=b.map((x,V)=>Object.values(ne).includes(x.type)||x.type===""?je(x,W(o[V])):!1);Promise.all(g).then(x=>{const V=[];if(x.forEach((w,$)=>{w&&V.push({blob:b[$],filename:o[$]})}),V.length){const w=V.map(($,T)=>{const Q=$.filename;return new File([$.blob],Q,{type:ne[W(Q)]})});G(w,n)}else l[n]=!1,g.length&&f.$message({message:"出问题啦，请检查上传的文件内的图片能正常访问",type:"error",duration:1e3})})})}const d=()=>{z.value=!1,s("submit")};return(e,o)=>{const n=y("el-button"),b=y("com-dialog");return u(),h(b,{modelValue:z.value,"onUpdate:modelValue":o[0]||(o[0]=g=>z.value=g),title:"存储桶数据迁移",width:"600px","before-close":d},{action:i(()=>[c(n,{onClick:d},{default:i(()=>[k("取 消")]),_:1}),c(n,{type:"primary",onClick:q},{default:i(()=>[k("确 定")]),_:1})]),default:i(()=>[a("p",Ee,"图片标准: 图片类型存在于 "+j(B.value.system.accept.join(", "))+" 中",1),a("div",Pe,[Fe,Ne,a("div",Ze,[c(n,{loading:l.export_excel,type:"success",icon:"Download",onClick:m},{default:i(()=>[k("导出excel")]),_:1},8,["loading"]),c(n,{loading:l.import_excel,type:"primary",icon:"Upload",onClick:O},{default:i(()=>[k(" 导入excel "),a("input",{type:"file",ref_key:"excelRef",ref:R,accept:".xlsx",onChange:J},null,544)]),_:1},8,["loading"])])]),a("div",qe,[Le,Te,a("div",Me,[c(n,{loading:l.export_zip,type:"success",icon:"Download",onClick:A},{default:i(()=>[k("导出ZIP包")]),_:1},8,["loading"]),c(n,{loading:l.import_zip,type:"primary",icon:"Upload",onClick:F},{default:i(()=>[k(" 导入ZIP包 "),a("input",{type:"file",ref_key:"zipRef",ref:r,accept:".zip",onChange:L},null,544)]),_:1},8,["loading"])])])]),_:1},8,["modelValue"])}}}),Je={class:"bucket-item"},Ge={class:"bucket-item-square"},He={key:0,class:"trialfont trial-bianji"},Ke=["src"],Qe={key:0,class:"bucket-item-tip"},We=a("span",{class:"trialfont trial-bianji"},null,-1),Xe={class:"bucket-item-tags"},Ye={class:"bucket-item-content"},et={class:"bucket-content-title"},tt={class:"bucket-content-count"},lt={class:"bucket-content-time"},at={class:"bucket-item-action"},re=K({__name:"BucketItem",props:{create:{type:Boolean,default:!1},detail:{default:()=>({id:0,name:"",user_plugin:{plugin:{logo:""}},stats:{}})},editable:{type:Boolean,default:!1},stats:{}},setup(E){return(p,v)=>{const s=y("el-tag");return u(),U("div",Je,[a("div",Ge,[p.create?(u(),U("span",He)):(u(),U("img",{key:1,src:p.detail.user_plugin.plugin.logo,alt:""},null,8,Ke))]),p.create?(u(),U("div",Qe,[We,k("新建存储桶 ")])):(u(),U(M,{key:1},[p.editable?(u(),h(Se,{key:0})):Z("",!0),a("div",Xe,[c(s,{size:"small",type:"success"},{default:i(()=>[k(j(p.detail.user_plugin.plugin.title),1)]),_:1}),c(s,{size:"small",type:p.detail.visible?"":"danger"},{default:i(()=>[k(j(p.detail.visible?"已启用":"已禁用"),1)]),_:1},8,["type"])]),a("div",Ye,[a("div",et,[c(s,{size:"small",effect:"dark",type:"success"},{default:i(()=>[k(j(p.detail.user_plugin.version),1)]),_:1}),k(" "+j(p.detail.name),1)]),a("div",tt,[c(s,{type:"info",size:"small"},{default:i(()=>[k("图片数量: "+j(p.stats.bucket_count),1)]),_:1}),c(s,{type:"info",size:"small"},{default:i(()=>[k("占用存储: "+j(p.stats.bucket_storage)+"MB",1)]),_:1})]),a("div",lt," 更新于: "+j(p.detail.updatedAt),1)]),a("div",at,[$e(p.$slots,"action")])],64))])}}}),nt={class:"bucket-container"},ot=["onClick"],st=["onClick"],it=["onClick"],ut=["onClick"],ft=K({__name:"index",setup(E){const p=ae(),v=new me,s=H({total:0,filters:{search:""},data:[],stats:[],versions:[],loading:!1});let C=H({data:null});const f=H({edit:!1,migrate:!1}),S=()=>{s.loading=!0,v.find({...s.filters}).then(m=>{s.total=m.total,s.data=m.items.map(r=>(r.createdAt=oe(r.createdAt),r.updatedAt=oe(r.updatedAt),r)),s.stats=m.stats.map(r=>(r.bucket_storage=r.bucket_storage?(parseInt(r.bucket_storage)/1021/1024).toFixed(2):0,r)),s.loading=!1})};S();const z=(m,r)=>{C.data=m&&JSON.parse(JSON.stringify(m)),f[r]=!0,r==="delete"&&se("确定要删除本存储桶吗？(删除后关联的图片将无法访问)").then(()=>{v.delete(m.id).then(F=>{p.$message({message:"删除成功",type:"success",duration:1e3}),S()})}),r==="toggle"&&se(`确定要${m.visible?"禁用":"启用"}该存储桶吗？`).then(()=>{v.toggle(m.id).then(F=>{p.$message({message:`${m.visible?"禁用":"启用"}成功`,type:"success",duration:1e3}),S()})})},l=D(!1);function P(){l.value=!l.value,B()}function B(){we(()=>{be(document.querySelector("#sortableRef"),s.data,q)})}function q(m,r){s.loading=!0;const[F,L]=[s.data[m-1],s.data[r-1]];v.sort(F.id,L.id).then(()=>{S()})}function N(m){return s.stats.find(r=>r.id===m.id)}function A(m){setTimeout(()=>{S()},1e3)}return(m,r)=>{const F=y("el-button"),L=y("el-input"),R=y("el-col"),O=y("el-row"),J=y("c-card"),G=ce("loading");return u(),U("div",nt,[c(J,{title:`存储桶(${s.total})`},{cardAction:i(()=>[c(F,{onClick:P},{default:i(()=>[k(j(l.value?"完成排序":"启用排序"),1)]),_:1}),c(L,{modelValue:s.filters.search,"onUpdate:modelValue":r[0]||(r[0]=_=>s.filters.search=_),placeholder:"请输入搜索内容...",style:{width:"180px"},"suffix-icon":"Search",clearable:"",onInput:A},null,8,["modelValue"])]),default:i(()=>[pe((u(),h(O,{id:"sortableRef"},{default:i(()=>[c(R,{xl:6,lg:8,md:12},{default:i(()=>[c(re,{create:!0,onClick:r[1]||(r[1]=_=>z(null,"edit"))})]),_:1}),(u(!0),U(M,null,Y(s.data,(_,d)=>(u(),h(R,{key:"bucket-item-"+d+"-"+_.id,xl:6,lg:8,md:12,class:"drag-box-col"},{default:i(()=>[(u(),h(re,{key:_.id,detail:_,stats:N(_),editable:l.value},{action:i(()=>[a("div",{class:"bucket-action-item",onClick:e=>z(_,"edit")},"编辑",8,ot),a("div",{class:"bucket-action-item",onClick:e=>z(_,"toggle")},j(_.visible?"禁用":"启用"),9,st),a("div",{class:"bucket-action-item",onClick:e=>z(_,"delete")},"删除",8,it),a("div",{class:"bucket-action-item",onClick:e=>z(_,"migrate")},"迁移",8,ut)]),_:2},1032,["detail","stats","editable"]))]),_:2},1024))),128))]),_:1})),[[G,s.loading]])]),_:1},8,["title"]),f.edit?(u(),h(Re,{key:0,modelValue:f.edit,"onUpdate:modelValue":r[2]||(r[2]=_=>f.edit=_),detail:ue(C).data,onSubmit:S},null,8,["modelValue","detail"])):Z("",!0),f.migrate?(u(),h(Oe,{key:1,modelValue:f.migrate,"onUpdate:modelValue":r[3]||(r[3]=_=>f.migrate=_),detail:ue(C).data,onSubmit:S},null,8,["modelValue","detail"])):Z("",!0)])}}});export{ft as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
