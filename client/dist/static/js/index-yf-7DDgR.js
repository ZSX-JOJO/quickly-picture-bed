import{u as J,p as M,l as ce,e as me,q as P,o as K,r as pe}from"./index-08v4467x.js";import{B as _e}from"./Bucket-R4Fjio79.js";import{I as O}from"./Image-ib0n8ZLM.js";import{_ as fe,G as ge}from"./DetailDialog.vue_vue_type_style_index_0_lang-Es2JB6vr.js";import{A as ve}from"./Album-P1ywBcV4.js";import{f as Q,K as j,r as A,v as m,x as n,i as d,o as s,h as i,A as _,I as B,g as k,C as I,F as C,a as Y,w as be,af as ye,z as T,a5 as he,Y as ke,y as we,B as H,L as Ve,s as xe,p as Ce,j as Ae}from"./vendor-DwjfiTos.js";import"./dragBox-OpJUmZcL.js";import"./date-time-ZUNy4mC1.js";const Be=B("p",{style:{"margin-bottom":"10px"}},"相册列表",-1),Se=Q({__name:"AlbumDialog",props:{modelValue:{type:Boolean,default:!1},ids:{default:()=>[]}},emits:["update:modelValue","submit"],setup(q,{emit:U}){const p=q,f=U,S=new ve,R=new O,w=J(),t=j({get(){return p.modelValue},set(v){f("update:modelValue",v)}}),g=A([]),r=A(null);function x(){t.value=!1}function $(){S.find({}).then(v=>{g.value=[...v.items.map(o=>({label:o.name,value:o.id,desc:o.desc}))]})}$();function u(){p.ids.forEach((v,o)=>{R.update({id:v,album_id:r.value}).then(async z=>{o===p.ids.length-1&&(w.$message({message:"移入成功",duration:1e3,type:"success"}),f("submit"))})})}return(v,o)=>{const z=d("el-option"),E=d("el-select"),D=d("el-button"),F=d("com-dialog");return s(),m(F,{modelValue:t.value,"onUpdate:modelValue":o[1]||(o[1]=b=>t.value=b),title:"移入相册",width:"600px","before-close":x},{action:n(()=>[i(D,{type:"default",onClick:x},{default:n(()=>[_("取消")]),_:1}),i(D,{type:"primary",onClick:u,disabled:!r.value},{default:n(()=>[_("确定")]),_:1},8,["disabled"])]),default:n(()=>[B("div",null,[Be,i(E,{modelValue:r.value,"onUpdate:modelValue":o[0]||(o[0]=b=>r.value=b),filterable:"",style:{width:"100%"}},{default:n(()=>[(s(!0),k(C,null,I(g.value,(b,N)=>(s(),m(z,{key:N,label:b.label,value:b.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),_:1},8,["modelValue"])}}}),$e={class:"gallery-container"},ze={class:"gallery-filter"},De={class:"gallery-list"},Te={key:1,class:"empty-data"},Ge=Q({__name:"index",setup(q){const U=new _e,p=new O,f=J(),S=he(),R=ke(),w=A(!1),t=Y({page:1,size:18,total:0,loading:!1,filters:{search:"",bucket_id:0,user_id:0},data:[]}),g=j(()=>t.data.filter(a=>a.checked)),r=A(!1),x=A([{name:"全部",id:0}]),$=j(()=>t.data.filter(a=>a.checked).length===0),u=Y({detail:!1,move:!1,data:null}),v=()=>{t.loading=!0,U.find({}).then(a=>{x.value=[{id:0,name:"全部"},...a.items.map(e=>e)],o()})},o=()=>{p.find({page:t.page,size:t.size,...t.filters}).then(a=>{t.total=a.total,t.data=a.items.map(e=>(e.preview_url=e.baseurl+e.url,e.createdAt=M(e.createdAt),e.updatedAt=M(e.updatedAt),e)),t.loading=!1})};function z(){const a=t.data.filter(e=>e.checked)[0];Ce.prompt("请输入新的文件名","文件重命名",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^(?!\s*$).+/,inputErrorMessage:"请输入新的文件名，文件名不符合标准",inputType:"textarea",inputPlaceholder:"请输入新文件名",inputValue:a.origin_name}).then(({value:e})=>{p.update({id:a.id,origin_name:e}).then(c=>{f.$message({message:"重命名成功",duration:1e3,type:"success"}),o()})}).catch(()=>{})}const E=()=>{r.value=!r.value,t.data.forEach(a=>{a.checked=r.value})};function D(a){const e=g.value.map(c=>{const y={url:c.preview_url,filename:c.name};return a.value.replace(/\$\{(.*?)\}/g,(G,h)=>y[h])}).join(`
`);me(f,e)}const F=a=>{f.$viewerApi({options:{initialViewIndex:a},images:t.data.map(e=>e.preview_url)})},b=a=>{switch(a.type){case"delete":K("确定删除吗?(由于对象存储几乎不要钱，故此处只是删除本条记录，不会删除对象存储上的原数据，所以删除后仍然能正常访问)").then(()=>{p.delete(a.data.id).then(e=>{f.$message({message:"删除成功",type:"success",duration:1e3}),o()})});break;case"detail":u[a.type]=!0,u.data=a.data;break;case"update":P(t,S.name,"set"),R.push({path:"/",query:{img_id:a.data.id}});break}},N=()=>{const a=t.data.filter(e=>e.checked).map(e=>e.id);K("确定删除吗?(由于对象存储几乎不要钱，故此处只是删除记录，不会删除对象存储上的原数据，所以删除后仍然能正常访问)").then(()=>{a.map((e,c)=>{p.delete(e).then(y=>{c===a.length-1&&(f.$message({message:"删除成功",duration:1e3,type:"success"}),o())})})})};function W(){u.move=!0}const X=a=>{setTimeout(()=>{o()},1e3)};function Z(){w.value=!w.value,ee()}function ee(){Ae(()=>{pe(document.querySelector("#sortableRef"),t.data,te)})}function te(a,e){const[c,y]=[t.data[a],t.data[e]];t.loading=!0,p.sort(c.id,y.id).then(()=>{o()})}return be(()=>t.data,(a,e)=>{t.data.filter(y=>y.checked).length===t.data.length?r.value=!0:r.value=!1},{deep:!0,immediate:!0}),ye(()=>{P(t,S.name,"get",v)}),(a,e)=>{const c=d("el-input"),y=d("el-option"),G=d("el-select"),h=d("el-button"),ae=d("el-dropdown-item"),le=d("el-dropdown-menu"),oe=d("el-dropdown"),ne=d("el-col"),se=d("el-row"),de=d("el-empty"),ie=d("pagination"),ue=d("c-card"),re=we("loading");return s(),k("div",$e,[i(ue,{title:"图库"},{cardAction:n(()=>[i(c,{modelValue:t.filters.search,"onUpdate:modelValue":e[0]||(e[0]=l=>t.filters.search=l),placeholder:"请输入搜索内容...",style:{width:"180px"},"suffix-icon":"Search",clearable:"",onInput:X},null,8,["modelValue"])]),default:n(()=>[B("div",ze,[B("div",null,[i(G,{modelValue:t.filters.bucket_id,"onUpdate:modelValue":e[1]||(e[1]=l=>t.filters.bucket_id=l),placeholder:"请选择需要显示的图床",filterable:"",onChange:o},{default:n(()=>[(s(!0),k(C,null,I(x.value,(l,V)=>(s(),m(y,{key:"bucket-"+V,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),B("div",null,[g.value.length===1?(s(),m(h,{key:0,type:"warning",onClick:z},{default:n(()=>[_("重命名")]),_:1})):T("",!0),g.value.length?(s(),k(C,{key:1},[i(oe,{class:"copy-link-type",trigger:"click",onCommand:e[2]||(e[2]=l=>l())},{dropdown:n(()=>[i(le,null,{default:n(()=>[(s(!0),k(C,null,I(Ve(ce),(l,V)=>(s(),m(ae,{key:V,label:l.label,value:l.id,command:()=>D(l)},{default:n(()=>[_(H(l.label),1)]),_:2},1032,["label","value","command"]))),128))]),_:1})]),default:n(()=>[i(h,{type:"primary",icon:"DocumentCopy"},{default:n(()=>[_("复制链接")]),_:1})]),_:1}),i(h,{type:"primary",icon:"Position",onClick:W},{default:n(()=>[_("移入相册")]),_:1})],64)):T("",!0),i(h,{type:"primary",icon:"Checked",onClick:E},{default:n(()=>[_("全选")]),_:1}),i(h,{type:$.value?"default":"danger",icon:"Delete",disabled:$.value,onClick:N},{default:n(()=>[_(" 删除所选 ")]),_:1},8,["type","disabled"]),i(h,{onClick:Z},{default:n(()=>[_(H(w.value?"完成排序":"启用排序"),1)]),_:1})])]),xe((s(),k("div",De,[t.data.length?(s(),m(se,{key:0,id:"sortableRef"},{default:n(()=>[(s(!0),k(C,null,I(t.data,(l,V)=>(s(),m(ne,{key:"gallery-item-"+V+"-"+l.id,xl:4,lg:6,md:8,sm:12,xs:24,class:"drag-box-col"},{default:n(()=>[(s(),m(ge,{data:l,key:l.id,editable:w.value,images:t.data.map(L=>L.preview_url),onReload:o,onSubmit:b,onView:L=>F(V)},null,8,["data","editable","images","onView"]))]),_:2},1024))),128))]),_:1})):(s(),k("div",Te,[i(de,{description:"暂无数据"})]))])),[[re,t.loading]]),i(ie,{page:t.page,"onUpdate:page":e[3]||(e[3]=l=>t.page=l),size:t.size,"onUpdate:size":e[4]||(e[4]=l=>t.size=l),total:t.total,"page-sizes":[18,36,72,100],onChange:o},null,8,["page","size","total"])]),_:1}),u.detail?(s(),m(fe,{key:0,"model-value":u.detail,"show-album":!0,id:u.data.id,onSubmit:o,"onUpdate:modelValue":e[5]||(e[5]=l=>u.detail=l)},null,8,["model-value","id"])):T("",!0),g.value.length&&u.move?(s(),m(Se,{key:1,"model-value":u.move,ids:g.value.map(l=>l.id),onSubmit:o,"onUpdate:modelValue":e[6]||(e[6]=l=>u.move=l)},null,8,["model-value","ids"])):T("",!0)])}}});export{Ge as default};
