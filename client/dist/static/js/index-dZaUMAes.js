import{u as W,a as Y,x as X,P as Z,o as M,r as ee}from"./index-lYYcvhZ6.js";import{_ as te}from"./plugin-item.vue_vue_type_style_index_0_lang-qZshpNT2.js";import{f as H,K as L,a as j,r as F,w as Q,v as y,x as n,i as r,o as u,h as o,A as x,g as f,F as _,C as D,z as T,e as le,I as E,s as ae,L as oe,j as ne,y as se,Y as ie,B as ue}from"./vendor-DwjfiTos.js";import"./dragBox-cYxTLZvC.js";const re=H({__name:"edit-plugin",props:{modelValue:{type:Boolean,default:!1},detail:{default:()=>({})}},emits:["update:modelValue","submit"],setup(O,{emit:$}){const h=O,U=$,R=W(),P=new Z,s=Y(),z=L({get(){return h.modelValue},set(a){U("update:modelValue",a)}}),e=j({name:"",title:"",version:"",logo:"",description:"",author:"",category:"",platform:"",status:!1,payment:!1,payment_type:"free",price:0,tags:[]}),b=j({name:[{required:!0,message:"请输入插件名称",trigger:["blur","change"]}],title:[{required:!0,message:"请输入插件别名",trigger:["blur","change"]}],platform:[{required:!0,message:"请选择运行环境",trigger:["blur","change"]}]}),N=F(null),q=F([]),A=F(),V=L(()=>({plugin_type:s.dicts.find(a=>a.code==="plugin_type").values||[],plugin_env:s.dicts.find(a=>a.code==="plugin_env").values||[],plugin_payment_type:s.payment_types})),g=j({pkg:!1,submit:!1}),S=()=>{z.value=!1};function G(){N.value.validate(a=>{a&&(g.submit=!0,e.id?P.update(e).then(t=>{R.$message({message:"更新成功",duration:1e3,type:"success"}),g.submit=!1,S(),U("submit")}):P.create(e).then(t=>{R.$message({message:"创建功",duration:1e3,type:"success"}),g.submit=!1,S(),U("submit")}))})}function i(){g.pkg=!0,le({method:"get",url:`${X}/${e.name}?time=${Math.random()}`}).then(a=>{A.value=a.data;const{"dist-tags":t,versions:c}=a.data;q.value=Object.keys(c).reverse();const v=t.latest;e.version=v,g.pkg=!1}).catch(a=>{R.$message({message:a.message,duration:1e3,type:"error"}),g.pkg=!1})}function d(a){const{author:t,description:c,logo:v,keywords:m,category:k}=A.value.versions[a];e.author=t.name,e.description=c,e.version=a,e.category=k||"uploader",e.tags=m&&m.slice(0,5)||["uploader","plugin"],e.logo=v||"https://himg.bdimg.com/sys/portrait/item/public.1.1f2977ac.EaP-d0ojVIWjmGyxrZ326Q.jpg"}function C(a){a?e.payment_type="paid":(e.payment_type="free",e.price=0)}return Q(()=>h.detail,a=>{if(a){e.id=h.detail.id;for(let t in e)e[t]=h.detail[t],t==="payment"&&(e[t]=!!h.detail[t])}},{immediate:!0}),Q(()=>e.version,a=>{d(a)}),(a,t)=>{const c=r("el-button"),v=r("el-input"),m=r("el-form-item"),k=r("el-option"),B=r("el-select"),p=r("el-switch"),I=r("el-input-number"),K=r("el-form"),J=r("com-dialog");return u(),y(J,{modelValue:z.value,"onUpdate:modelValue":t[9]||(t[9]=l=>z.value=l),title:a.detail&&a.detail.id?"编辑插件":"新建插件",width:"700px","before-close":S},{action:n(()=>[o(c,{onClick:S},{default:n(()=>[x("取 消")]),_:1}),o(c,{type:"primary",loading:g.submit,onClick:G},{default:n(()=>[x("确 定")]),_:1},8,["loading"])]),default:n(()=>[o(K,{ref_key:"formRef",ref:N,model:e,rules:b,"label-width":"80px","label-position":"left",class:"plugin-form"},{default:n(()=>[o(m,{label:"插件名称",prop:"name"},{default:n(()=>[o(v,{modelValue:e.name,"onUpdate:modelValue":t[0]||(t[0]=l=>e.name=l),size:"large"},{append:n(()=>[o(c,{onClick:i,loading:g.pkg},{default:n(()=>[x("插件信息")]),_:1},8,["loading"])]),_:1},8,["modelValue"])]),_:1}),o(m,{label:"插件别名",prop:"title"},{default:n(()=>[o(v,{modelValue:e.title,"onUpdate:modelValue":t[1]||(t[1]=l=>e.title=l),size:"large"},null,8,["modelValue"])]),_:1}),e.category?(u(),f(_,{key:0},[o(m,{label:"插件类别",prop:"category"},{default:n(()=>[o(B,{modelValue:e.category,"onUpdate:modelValue":t[2]||(t[2]=l=>e.category=l),size:"large",disabled:"",style:{width:"100%"}},{default:n(()=>[(u(!0),f(_,null,D(V.value.plugin_type,(l,w)=>(u(),y(k,{key:"type-"+w,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(m,{label:"插件版本",prop:"version"},{default:n(()=>[o(B,{modelValue:e.version,"onUpdate:modelValue":t[3]||(t[3]=l=>e.version=l),size:"large",style:{width:"100%"}},{default:n(()=>[(u(!0),f(_,null,D(q.value,(l,w)=>(u(),y(k,{key:"version-"+w,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(m,{label:"插件描述",prop:"description"},{default:n(()=>[o(v,{type:"textarea",rows:"3",modelValue:e.description,"onUpdate:modelValue":t[4]||(t[4]=l=>e.description=l),size:"large"},null,8,["modelValue"])]),_:1}),o(m,{label:"运行环境",prop:"platform"},{default:n(()=>[o(B,{modelValue:e.platform,"onUpdate:modelValue":t[5]||(t[5]=l=>e.platform=l),size:"large",style:{width:"100%"}},{default:n(()=>[(u(!0),f(_,null,D(V.value.plugin_env,(l,w)=>(u(),y(k,{key:"env-"+w,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})],64)):T("",!0),o(m,{label:"是否付费",prop:"payment"},{default:n(()=>[o(p,{modelValue:e.payment,"onUpdate:modelValue":t[6]||(t[6]=l=>e.payment=l),onChange:C},null,8,["modelValue"])]),_:1}),e.payment?(u(),f(_,{key:1},[o(m,{label:"付费版本",prop:"payment_type"},{default:n(()=>[o(B,{modelValue:e.payment_type,"onUpdate:modelValue":t[7]||(t[7]=l=>e.payment_type=l),size:"large",style:{width:"100%"}},{default:n(()=>[(u(!0),f(_,null,D(V.value.plugin_payment_type,(l,w)=>(u(),f(_,{key:w},[l.value!=="free"?(u(),y(k,{key:0,label:l.label,value:l.value},null,8,["label","value"])):T("",!0)],64))),128))]),_:1},8,["modelValue"])]),_:1}),o(m,{label:"价格(元)",prop:"price"},{default:n(()=>[o(I,{modelValue:e.price,"onUpdate:modelValue":t[8]||(t[8]=l=>e.price=l),precision:2,min:0},null,8,["modelValue"])]),_:1})],64)):T("",!0)]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])}}}),de={class:"plugin-container"},pe={class:"plugin-toolbar"},me={class:"plugin-toolbar-filter"},ce={class:"plugin-toolbar-action"},be=H({__name:"index",setup(O){const $=new Z,h=ie(),U=W(),R=Y(),P=L(()=>[{label:"全部",value:""},...R.dicts.find(i=>i.code==="plugin_type").values||[]]),s=j({page:1,size:10,total:0,filters:{search:"",category:""},loading:!1,data:[]});let z=j({data:null});const e=j({edit:!1,detail:!1});function b(){s.loading=!0,$.find({...s.filters}).then(i=>{s.data=i.items,s.total=i.total,s.loading=!1})}b();function N(i){h.push({name:"SystemPluginDetail",query:{plugin_id:i.id}})}function q(i){switch(z.data=i.data,e[i.type]=!0,i.type){case"edit":break;case"switch":const{status:d,id:C}=i.data;M(`确定要${d?"禁用":"启用"}该存储源插件吗？`).then(()=>{$.toggle(C).then(a=>{U.$message({type:"success",duration:1e3,message:`${d?"禁用":"启用"}成功`}),b()})});break;case"delete":M().then(()=>{$.delete(i.data.id).then(a=>{U.$message({type:"success",duration:1e3,message:"删除成功"}),b()})});break}}function A(){Object.keys(s.filters).forEach(i=>{typeof s.filters[i]=="number"?s.filters[i]=0:s.filters[i]=""}),b()}const V=F(!1);function g(){V.value=!V.value,S()}function S(){ne(()=>{ee(document.querySelector("#sortableRef"),s.data,G)})}function G(i,d){s.loading=!0;const[C,a]=[s.data[i],s.data[d]];$.sort(C.id,a.id).then(()=>{b()})}return(i,d)=>{const C=r("el-input"),a=r("el-option"),t=r("el-select"),c=r("el-button"),v=r("el-col"),m=r("c-empty"),k=r("el-row"),B=se("loading");return u(),f(_,null,[E("div",de,[E("div",pe,[E("div",me,[o(C,{modelValue:s.filters.search,"onUpdate:modelValue":d[0]||(d[0]=p=>s.filters.search=p),placeholder:"请输入插件名称"},null,8,["modelValue"]),o(t,{modelValue:s.filters.category,"onUpdate:modelValue":d[1]||(d[1]=p=>s.filters.category=p),placeholder:"请选择插件类别"},{default:n(()=>[(u(!0),f(_,null,D(P.value,(p,I)=>(u(),y(a,{key:"type-"+I,label:p.label,value:p.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(c,{type:"primary",onClick:b},{default:n(()=>[x("查询")]),_:1}),o(c,{type:"default",onClick:A},{default:n(()=>[x("重置")]),_:1})]),E("div",ce,[o(c,{type:"primary",onClick:d[2]||(d[2]=p=>q({type:"edit",data:null}))},{default:n(()=>[x("新增")]),_:1}),o(c,{onClick:g},{default:n(()=>[x(ue(V.value?`完成排序(${s.total})`:`启用排序(${s.total})`),1)]),_:1})])]),ae((u(),y(k,{class:"plugin-list",id:"sortableRef"},{default:n(()=>[s.data.length?(u(!0),f(_,{key:0},D(s.data,(p,I)=>(u(),y(v,{key:"plugin-item-"+I+"-"+p.id,xl:6,lg:8,md:12,class:"drag-box-col"},{default:n(()=>[o(te,{detail:p,editable:!0,draggable:V.value,onClick:K=>N(p),onAction:q},null,8,["detail","draggable","onClick"])]),_:2},1024))),128)):(u(),y(m,{key:1}))]),_:1})),[[B,s.loading]])]),e.edit?(u(),y(re,{key:0,modelValue:e.edit,"onUpdate:modelValue":d[3]||(d[3]=p=>e.edit=p),detail:oe(z).data,onSubmit:b},null,8,["modelValue","detail"])):T("",!0)],64)}}});export{be as default};
